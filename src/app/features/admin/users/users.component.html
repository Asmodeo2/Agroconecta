<div class="users-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Gestión de Usuarios</h1>
      <p class="page-subtitle">Administra los usuarios del sistema AgroConecta</p>
    </div>
    <button class="btn btn-primary" (click)="openModal()">
      <i class="fas fa-plus"></i> Nuevo Usuario
    </button>
  </div>

  <!-- Estadísticas de usuarios -->
  <div class="stats-cards" *ngIf="statistics">
    <div class="stat-card">
      <div class="stat-icon bg-primary">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalUsers }}</h3>
        <p>Total Usuarios</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon bg-success">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalActiveUsers }}</h3>
        <p>Usuarios Activos</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon bg-info">
        <i class="fas fa-leaf"></i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalProductors }}</h3>
        <p>Productores</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon bg-warning">
        <i class="fas fa-user-shield"></i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalAdministrators }}</h3>
        <p>Administradores</p>
      </div>
    </div>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="filters-section">
    <div class="search-box">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          placeholder="Buscar por nombre o email..."
          [(ngModel)]="searchTerm"
          (input)="onSearch()">
        <span class="input-group-text">
          <i class="fas fa-search"></i>
        </span>
      </div>
    </div>

    <div class="filter-group">
      <select
        class="form-select"
        [(ngModel)]="selectedRole"
        (change)="onFilterChange()">
        <option value="">Todos los roles</option>
        <option *ngFor="let role of availableRoles" [value]="role.value">{{ role.label }}</option>
      </select>

      <select
        class="form-select"
        [(ngModel)]="selectedStatus"
        (change)="onFilterChange()">
        <option value="all">Todos los estados</option>
        <option value="active">Activos</option>
        <option value="inactive">Inactivos</option>
      </select>

      <button class="btn btn-outline-secondary" (click)="clearFilters()">
        <i class="fas fa-times"></i> Limpiar
      </button>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p>Cargando usuarios...</p>
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-container" *ngIf="!loading">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Registro</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of paginatedUsers">
          <td>
            <div class="user-info">
              <div class="user-avatar">
                <span class="avatar-initials">{{ getUserInitials(user) }}</span>
              </div>
              <div class="user-details">
                <h6 class="mb-0">{{ user.nombre }}</h6>
                <small class="text-muted" *ngIf="user.telefono">{{ user.telefono }}</small>
              </div>
            </div>
          </td>
          <td>
            <span class="user-email">{{ user.email }}</span>
          </td>
          <td>
            <span [class]="'role-badge role-' + getRoleColor(user.rol)">
              <i [class]="'fas fa-' + getRoleIcon(user.rol)"></i>
              {{ getRoleDisplayName(user.rol) }}
            </span>
          </td>
          <td>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                [checked]="user.activo"
                (change)="toggleUserStatus(user)"
                [disabled]="!canEditUser(user)">
              <label class="form-check-label">
                {{ user.activo ? 'Activo' : 'Inactivo' }}
              </label>
            </div>
          </td>
          <td>
            <div class="date-info">
              <div>{{ formatDate(user.fechaRegistro!) }}</div>
              <small class="text-muted">{{ getDaysActive(user.fechaRegistro!) }} días</small>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button
                class="btn btn-sm btn-outline-primary"
                (click)="openModal(user)"
                title="Editar usuario"
                [disabled]="!canEditUser(user)">
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn btn-sm btn-outline-warning"
                (click)="openPasswordModal(user)"
                title="Cambiar contraseña"
                [disabled]="!canEditUser(user)">
                <i class="fas fa-key"></i>
              </button>
              <button
                class="btn btn-sm btn-outline-danger"
                (click)="confirmDelete(user)"
                title="Eliminar usuario"
                [disabled]="!canDeleteUser(user)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Estado vacío -->
    <div *ngIf="filteredUsers.length === 0" class="empty-state">
      <i class="fas fa-users fa-3x text-muted"></i>
      <h4>No hay usuarios</h4>
      <p class="text-muted">
        {{ searchTerm || selectedRole || selectedStatus !== 'all' ? 'No se encontraron usuarios con los filtros aplicados' : 'Aún no tienes usuarios registrados' }}
      </p>
      <button *ngIf="!searchTerm && !selectedRole && selectedStatus === 'all'" class="btn btn-primary" (click)="openModal()">
        Agregar primer usuario
      </button>
    </div>
  </div>

  <!-- Paginación -->
  <nav *ngIf="totalPages > 1" aria-label="Paginación de usuarios">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="changePage(currentPage - 1)">Anterior</button>
      </li>
      <li *ngFor="let page of [].constructor(totalPages); let i = index"
          class="page-item"
          [class.active]="currentPage === i + 1">
        <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="changePage(currentPage + 1)">Siguiente</button>
      </li>
    </ul>
  </nav>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="userForm" (ngSubmit)="saveUser()">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label" for="nombre">Nombre Completo *</label>
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  formControlName="nombre"
                  [class.is-invalid]="userForm.get('nombre')?.invalid && userForm.get('nombre')?.touched">
                <div class="invalid-feedback" *ngIf="userForm.get('nombre')?.invalid && userForm.get('nombre')?.touched">
                  El nombre es requerido (mínimo 2 caracteres)
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label" for="email">Email *</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  [readonly]="!!editingUser"
                  [class.is-invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                <div class="invalid-feedback" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                  Email inválido
                </div>
                <small class="form-text text-muted" *ngIf="editingUser">
                  El email no se puede modificar
                </small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label" for="telefono">Teléfono</label>
                <input
                  type="tel"
                  class="form-control"
                  id="telefono"
                  formControlName="telefono"
                  placeholder="+51987654321"
                  [class.is-invalid]="userForm.get('telefono')?.invalid && userForm.get('telefono')?.touched">
                <div class="invalid-feedback" *ngIf="userForm.get('telefono')?.invalid && userForm.get('telefono')?.touched">
                  Formato de teléfono inválido
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label" for="rol">Rol *</label>
                <select
                  class="form-select"
                  id="rol"
                  formControlName="rol"
                  [class.is-invalid]="userForm.get('rol')?.invalid && userForm.get('rol')?.touched">
                  <option value="">Seleccionar rol</option>
                  <option *ngFor="let role of availableRoles" [value]="role.value">
                    {{ role.label }} - {{ role.description }}
                  </option>
                </select>
                <div class="invalid-feedback" *ngIf="userForm.get('rol')?.invalid && userForm.get('rol')?.touched">
                  Selecciona un rol
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3" *ngIf="!editingUser">
            <label class="form-label" for="password">Contraseña *</label>
            <input
              type="password"
              class="form-control"
              id="password"
              formControlName="password"
              (input)="onPasswordInput()"
              [class.is-invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            <div class="invalid-feedback" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
              <span *ngIf="userForm.get('password')?.errors?.['required']">La contraseña es requerida</span>
              <span *ngIf="userForm.get('password')?.errors?.['minlength']">Mínimo 8 caracteres</span>
              <span *ngIf="userForm.get('password')?.errors?.['weakPassword']">{{ userForm.get('password')?.errors?.['weakPassword'] }}</span>
            </div>
            <div class="form-text">
              La contraseña debe tener al menos 8 caracteres, incluir mayúsculas, minúsculas y números.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid">
            {{ editingUser ? 'Actualizar' : 'Crear' }} Usuario
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para cambiar contraseña -->
<div class="modal fade" [class.show]="showPasswordModal" [style.display]="showPasswordModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cambiar Contraseña: {{ userToChangePassword?.nombre }}</h5>
        <button type="button" class="btn-close" (click)="closePasswordModal()"></button>
      </div>
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="currentPassword">Contraseña Actual *</label>
            <input
              type="password"
              class="form-control"
              id="currentPassword"
              formControlName="currentPassword"
              [class.is-invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
            <div class="invalid-feedback" *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
              La contraseña actual es requerida
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="newPassword">Nueva Contraseña *</label>
            <input
              type="password"
              class="form-control"
              id="newPassword"
              formControlName="newPassword"
              [class.is-invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
            <div class="invalid-feedback" *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
              La nueva contraseña debe tener al menos 8 caracteres
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="confirmPassword">Confirmar Nueva Contraseña *</label>
            <input
              type="password"
              class="form-control"
              id="confirmPassword"
              formControlName="confirmPassword"
              [class.is-invalid]="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
            <div class="invalid-feedback" *ngIf="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
              Las contraseñas no coinciden
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closePasswordModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="passwordForm.invalid">
            Cambiar Contraseña
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" (click)="showDeleteModal = false"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar el usuario <strong>{{ userToDelete?.nombre }}</strong>?</p>
        <p class="text-muted">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showDeleteModal = false">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="deleteUser()">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay para modales -->
<div class="modal-backdrop fade" [class.show]="showModal || showDeleteModal || showPasswordModal" *ngIf="showModal || showDeleteModal || showPasswordModal"></div>